<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestão da Classificação de Risco Sanitário</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <style>
    :root{
      --bg: 18,18,22; --fg: 245,245,248; --muted-rgb: 160,168,185; --primary: 72,149,239;
      --ok: 36,161,72; --warn: 231,176,35; --danger: 217,65,65; --violet: 135,99,255;
      --card-bg: 30,32,40; --card-bg-a: .8; --table-head-bg: 38,40,48;
      --input-bg: 0,0,0; --input-bg-a: .25; --modal-bg: 28,30,38; --modal-bg-a: .96; --border: 255,255,255;
      --radius: 16px;
      --shadow-1: 0 4px 12px rgba(0,0,0,.25);
      --shadow-2: 0 8px 24px rgba(0,0,0,.35);
    }
    [data-theme="light"]{
      --bg: 242,244,249; --fg: 22,26,34; --muted-rgb: 93,104,117; --primary: 60,130,220;
      --ok: 30,140,65; --warn: 208,162,40; --danger: 206,68,68; --violet: 120,90,240;
      --card-bg: 255,255,255; --card-bg-a: .9; --table-head-bg: 248,250,252;
      --input-bg: 255,255,255; --input-bg-a: 1; --modal-bg: 255,255,255; --modal-bg-a: .98; --border: 0,0,0;
      --shadow-1: 0 4px 12px rgba(0,0,0,.08);
      --shadow-2: 0 8px 24px rgba(0,0,0,.1);
    }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.97); } to { opacity: 1; transform: scale(1); } }
    
    *{ box-sizing:border-box; } html, body{ height:100%; }
    body{
      margin:0; padding:32px; color: rgb(var(--fg));
      background-color: rgb(var(--bg));
      background-image:
        linear-gradient(rgba(var(--border), 0.05) 1px, transparent 1px),
        linear-gradient(to right, rgba(var(--border), 0.05) 1px, transparent 1px),
        radial-gradient(ellipse at 0% 0%, rgba(var(--primary), 0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 100% 100%, rgba(var(--violet), 0.12) 0%, transparent 50%);
      background-size: 24px 24px, 24px 24px, auto, auto;
      font: 14px/1.55 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    .main-grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
    header{ grid-column: 1 / -1; display:flex; align-items:center; gap:16px; flex-wrap:wrap; margin-bottom:16px; }
    .badge{ padding:6px 12px; border-radius:999px; font-weight:600; letter-spacing:.2px; background: rgba(var(--primary), .15); border:1px solid rgba(var(--primary), .3); color:rgb(var(--primary)); }
    .title{
      font-size: clamp(24px, 3vw, 32px); font-weight:800; letter-spacing:-.5px;
      background: linear-gradient(45deg, rgb(var(--fg)) 60%, rgba(var(--muted-rgb), .8));
      -webkit-background-clip: text; background-clip: text; color: transparent;
    }
    .glass{ background: rgba(var(--card-bg), var(--card-bg-a)); border: 1px solid rgba(var(--border), .1); box-shadow: var(--shadow-2); backdrop-filter: blur(12px) saturate(150%); border-radius: var(--radius); }
    
    .toolbar{ grid-column: 1 / -1; display:flex; gap:8px; flex-wrap:wrap; align-items:center; padding:12px; margin-bottom:16px; }
    button, .btn{
      appearance:none; border:none; cursor:pointer; padding:10px 14px; border-radius:12px; font-weight:600;
      color: rgb(var(--fg)); background: rgba(var(--border), .05);
      border:1px solid rgba(var(--border), .12); transition: all .15s ease; box-shadow: var(--shadow-1);
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    }
    button:hover{ transform: translateY(-1px); background: rgba(var(--border), .1); border-color: rgba(var(--border), .18); box-shadow: 0 6px 16px rgba(0,0,0,.2); }
    button:active{ transform: translateY(0); }
    button.primary{ background: rgb(var(--primary)); color:#fff; border-color: transparent; }
    button.primary:hover{ background: rgb(var(--primary)); filter: brightness(1.1); }
    input[type="file"]{ display:none; }
    .sep{ width:1px; height:28px; background: rgba(var(--border), .16); margin:0 8px; }
    .icon{ width: 16px; height: 16px; stroke-width: 2.5; }
    
    .panel{ padding:20px; }
    #dashboard{ grid-column: 1 / 2; display:flex; flex-direction:column; gap:16px; }
    .stats{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .stat{
      padding:16px; border-radius:12px; display:flex; flex-direction:column; gap:6px;
      border:1px solid rgba(var(--border), .1); background: rgba(var(--card-bg), calc(var(--card-bg-a) + .1));
      border-top: 3px solid; transition: transform .2s ease;
    }
    .stat:hover{ transform: translateY(-2px); }
    .stat-total{ border-color: rgba(var(--muted-rgb),.6); } .stat-i{ border-color:rgb(var(--ok)); } .stat-ii{ border-color:rgb(var(--warn)); } .stat-iii{ border-color:rgb(var(--danger)); }
    .stat .big{ font-size:24px; font-weight:800; }
    .muted{ color: rgba(var(--muted-rgb), .95); }
    .ok{ color: rgb(var(--ok)); } .warn{ color: rgb(var(--warn)); } .danger{ color: rgb(var(--danger)); } .violet{ color: rgb(var(--violet)); }

    .filter-grid { display: flex; flex-direction: column; gap: 12px; }
    .filter-group { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .search-wrapper{ position: relative; flex: 1; display: flex; align-items:center; }
    .search-wrapper .icon{ position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: rgba(var(--muted-rgb), .7); }
    .search-wrapper input{ padding-left: 40px !important; }
    input, select{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(var(--border), .16); background: rgba(var(--input-bg), var(--input-bg-a)); color: rgb(var(--fg)); outline:none; transition: all .2s ease; }
    input::placeholder{ color: rgba(var(--muted-rgb), .8); }
    input:focus, select:focus{ box-shadow: 0 0 0 3px rgba(var(--primary), .35); border-color: rgba(var(--primary), .65); }

    #table-container{ grid-column: 2 / 4; }
    .table-wrap{ overflow:auto; max-height: calc(100vh - 300px); border-radius: 12px; border: 1px solid rgba(var(--border), .1); }
    table{ width:100%; border-collapse:separate; border-spacing:0; }
    thead th{ position:sticky; top:0; z-index:2; background: rgba(var(--table-head-bg), 0.95); backdrop-filter: blur(8px); color: rgba(var(--fg), .92); text-align:left; font-weight:600; font-size: 13px; }
    th, td{ padding:12px 10px; border-bottom:1px solid rgba(var(--border), .08); vertical-align:top; }
    tbody tr{ transition: background-color .15s ease; }
    tbody tr:hover{ background: rgba(var(--border), .04); cursor: pointer; }
    tbody tr.risk-changed { background-color: rgba(var(--primary), 0.08); }
    tbody tr.risk-changed:hover { background-color: rgba(var(--primary), 0.15); }
    
    .chips{ display:flex; gap:6px; flex-wrap:wrap }
    .chip{ padding:4px 10px; border-radius:999px; background: rgba(var(--border), .08); font-size:12px; font-weight:500; color:rgba(var(--fg), .9) }
    .pill{ padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700; letter-spacing:.2px }
    .lvl-1{ background: rgba(var(--ok), .18); color: rgb(var(--ok)); }
    .lvl-2{ background: rgba(var(--warn), .18); color: rgb(var(--warn)); }
    .lvl-3{ background: rgba(var(--danger), .18); color: rgb(var(--danger)); }
    .lvl-p{ background: rgba(var(--violet), .18); color: rgb(var(--violet)); }
    
    details summary{ cursor:pointer; font-weight:600; margin:8px 0; list-style-position: inside; }
    .notice{ font-size:13px; color:rgba(var(--muted-rgb), .95); }
    [data-theme="light"] .notice { color:rgba(var(--muted-rgb), 1); }

    dialog{ border:none; padding:0; background: transparent; max-width: 1024px; width: 100%; }
    dialog::backdrop{ background: rgba(0,0,0,.55); backdrop-filter: blur(4px); }
    .modal{
      animation: fadeIn .25s ease forwards;
      width:100%; background: rgba(var(--modal-bg), var(--modal-bg-a)); border:1px solid rgba(var(--border), .12); border-radius: 20px; box-shadow: var(--shadow-2); overflow:hidden; max-height: 85vh; display:flex; flex-direction:column;
    }
    .modal header{ position:sticky; top:0; background: rgba(var(--table-head-bg), 0.9); backdrop-filter: blur(8px); border-bottom:1px solid rgba(var(--border), .12); padding:16px 24px; z-index: 10; }
    .modal .content{ padding:24px; overflow:auto; }
    .two{ display:grid; grid-template-columns: 1fr 1fr; gap:16px }
    .row{ display:flex; gap:12px; align-items: center; }
    .row input, .row select, .row textarea{
      flex:1; min-width:0; background: rgba(var(--input-bg), var(--input-bg-a));
      border:1px solid rgba(var(--border), .16); color: rgb(var(--fg)); padding:10px 12px; border-radius: 12px; outline: none;
    }
    .act{ display:grid; grid-template-columns: 1fr 1fr 1fr 110px 40px; gap:8px; align-items:center; margin-top:8px; }
    .act small{ opacity:.7 } .divider{ height:1px; background: rgba(var(--border), .12); margin:16px 0 } .small{ font-size:12px; font-weight: 500; }
    
    #toast{ position:fixed; bottom:-100px; left:50%; transform:translateX(-50%); background:rgb(var(--fg)); color:rgb(var(--bg)); padding:12px 18px; border-radius:12px; box-shadow: var(--shadow-2); opacity:0; transition:all .4s cubic-bezier(0.22, 1, 0.36, 1); font-weight: 600; z-index: 999; }
    #toast.show{ bottom: 32px; opacity: 1; }
    
    :focus-visible{ outline: 3px solid rgba(var(--primary), .55); outline-offset: 2px; border-radius: 8px; }
    
    @media (max-width: 960px) { .main-grid{ grid-template-columns: 1fr; } #table-container, #dashboard{ grid-column: 1 / -1; } .table-wrap{ max-height: 50vh; } }
  </style>
</head>
<body>
  <header>
    <span class="badge">VISA MG</span>
    <div class="title">Gestão da Classificação de Risco Sanitário</div>
  </header>

  <div class="toolbar glass">
    <label class="btn"><input id="fileBase" type="file" accept="application/json" /><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>Importar Vigente</label>
    <label class="btn"><input id="fileRevisado" type="file" accept="application/json" /><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>Importar Revisada</label>
    <span class="sep"></span>
    <button id="btnSyncIBGE" class="btn"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>Sincronizar CONCLA</button>
    <span class="sep"></span>
    <button id="btnExportJson" class="btn"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>Exportar JSON</button>
    <button id="btnExportExcel" class="btn"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>Exportar Excel</button>
    <span class="sep"></span>
    <button id="btnTheme" class="btn" title="Alternar tema"><span id="themeIcon"></span> <span id="themeLabel">—</span></button>
  </div>

<div class="main-grid">
  <div id="dashboard" class="panel glass">
    <h3 style="margin:0;">Dashboard</h3>
    <div class="stats" id="stats">
      <div class="stat stat-total"><div class="muted">Total de CNAEs</div><div class="big" id="statTotal">0</div><div class="muted small" id="statTotalBase">vigente: —</div></div>
      <div class="stat stat-i"><div class="muted">Nível I</div><div class="big ok" id="statI">0</div><div class="muted small" id="statIBase">vigente: —</div></div>
      <div class="stat stat-ii"><div class="muted">Nível II</div><div class="big warn" id="statII">0</div><div class="muted small" id="statIIBase">vigente: —</div></div>
      <div class="stat stat-iii"><div class="muted">Nível III</div><div class="big danger" id="statIII">0</div><div class="muted small" id="statIIIBase">vigente: —</div></div>
    </div>

    <div class="glass" style="padding:16px;">
      <div class="muted" style="font-weight:600; margin-bottom:6px;">Resumo vs. Base</div>
      <div id="resumoBase" class="notice">Importe base e revisado.</div>
    </div>

    <details class="glass" style="padding:16px;">
      <summary>Relatório de Mudanças</summary>
      <div id="relatorio" class="notice">Importe a Base e o Atual para gerar.</div>
    </details>

    <details class="glass" style="padding:16px;">
      <summary>Inconsistências Detectadas</summary>
      <div id="issues" class="notice">Nenhuma.</div>
    </details>
  </div>

  <div id="table-container" class="panel glass">
    <div class="filter-grid">
        <div class="search-wrapper">
            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            <input id="q" type="text" placeholder="Filtrar por CNAE ou Descrição..." />
        </div>
        <div class="filter-group">
            <select id="filtroNivelCombo" style="flex:1;">
                <option value="">Filtrar por Risco (todos)</option>
                <optgroup label="Níveis Únicos">
                    <option value="I">Somente Nível I</option>
                    <option value="II">Somente Nível II</option>
                    <option value="III">Somente Nível III</option>
                </optgroup>
                <optgroup label="Combinações de Níveis">
                    <option value="I,II">Somente Níveis I e II</option>
                    <option value="I,III">Somente Níveis I e III</option>
                    <option value="II,III">Somente Níveis II e III</option>
                    <option value="I,II,III">Somente Níveis I, II e III</option>
                </optgroup>
            </select>
            <select id="filtroDiretoriaCombo" style="flex:1;">
                <option value="">Filtrar por Diretoria (todas)</option>
            </select>
        </div>
    </div>
    <div class="table-wrap" style="margin-top:16px;">
      <table id="grid">
        <thead>
          <tr>
            <th style="min-width:110px;">CNAE</th>
            <th style="min-width:280px;">Descrição (IBGE)</th>
            <th style="min-width:180px;">Diretorias</th>
            <th style="min-width:120px;">Risco Vigente (base)</th>
            <th style="min-width:120px;">Risco Revisado</th>
            <th style="min-width:80px;">Ações</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="notice" style="margin-top:12px; text-align: right;">Clique em uma linha para <strong>editar</strong> os detalhes. Linhas destacadas indicam mudança de risco.</div>
  </div>
</div>


  <dialog id="dlg">
    <div class="modal">
      <header class="row" style="justify-content:space-between; align-items:center">
        <div class="row" style="align-items:center; gap:12px">
          <span id="dlgRisk" class="pill"></span>
          <span id="dlgCnae" class="badge" style="font-size: 14px; padding: 8px 14px;"></span>
          <h2 id="dlgTitle" style="margin:0; font-size:18px"></h2>
        </div>
        <div class="row"><button id="btnClose" class="btn"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div>
      </header>
      <div class="content">
        <div class="two">
          <div>
            <label class="small muted">Denominação (IBGE)</label>
            <input id="dlgDenom" />
          </div>
          <div>
            <label class="small muted">Notas / Observações</label>
            <input id="dlgObs" placeholder="Opcional" />
          </div>
        </div>
        <div class="divider"></div>
        <div class="row" style="justify-content:space-between; align-items:center">
          <h3 style="margin:0">Atividades (Condicionantes)</h3>
          <button id="btnAddAct" class="btn"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>Adicionar</button>
        </div>
        <div id="acts"></div>
      </div>
      <div class="row" style="justify-content:space-between; align-items:center; padding:16px 24px; border-top:1px solid rgba(var(--border), .12); background: rgba(var(--table-head-bg), .5)">
        <div class="small muted">O risco agregado mostra <strong>todos os níveis presentes</strong> (ex.: I/II/III) quando o CNAE possui mais de um risco possível.</div>
        <div class="row"><button id="btnSave" class="btn primary"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>Salvar Alterações</button></div>
      </div>
    </div>
  </dialog>

  <div id="toast"></div>

<script>
/* ======= Helpers ======= */
const $ = (q)=> document.querySelector(q);
const $$ = (q)=> Array.from(document.querySelectorAll(q));
const setText = (sel, v)=>{ const el = (typeof sel==='string')? $(sel): sel; if(!el){ console.warn('setText: elemento não encontrado', sel); return false; } el.textContent = v; return true; };
const setHtml = (sel, v)=>{ const el = (typeof sel==='string')? $(sel): sel; if(!el){ console.warn('setHtml: elemento não encontrado', sel); return false; } el.innerHTML = v; return true; };
const toast = (m)=>{ const t=$('#toast'); if(!t) return; t.textContent=m; t.classList.add('show'); setTimeout(()=>{ t.classList.remove('show'); }, 2200); };
const mapRoman = { '1':'I','2':'II','3':'III', 'I':'I','II':'II','III':'III' };
const mapArab  = { 'I':1,'II':2,'III':3, '1':1,'2':2,'3':3 };
function escapeHtml(str){ if(str==null) return ''; return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }
async function tryFetchJSON(url){
  try {
    const r = await fetch(url, { cache: 'no-store' });
    if (!r.ok) {
        console.error(`Falha ao carregar ${url}: Status ${r.status}`);
        return null;
    }
    return await r.json();
  } catch (e) {
    console.error(`Erro de rede ou JSON inválido ao carregar ${url}`, e);
    return null;
  }
}
const areSetsEqual = (a, b) => a.size === b.size && [...a].every(value => b.has(value));

/* ======= Tema (claro/escuro) ======= */
const themeIcons = {
  dark: `<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`,
  light: `<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`
};
function applyTheme(theme){
  document.documentElement.setAttribute('data-theme', theme);
  localStorage.setItem('visa_theme', theme);
  setText('#themeLabel', theme==='dark' ? 'Escuro' : 'Claro');
  setHtml('#themeIcon', themeIcons[theme]);
}
function initTheme(){
  const saved = localStorage.getItem('visa_theme');
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  applyTheme(saved || (prefersDark ? 'dark' : 'light'));
}

/* CNAE <-> subclasse id (IBGE) */
function cnaeToSubclassDigits(cnae){ return (cnae||'').replace(/[^0-9]/g,''); }
function subclassDigitsToCNAE(id){ const s=String(id||'').padStart(7,'0'); return `${s.slice(0,4)}-${s.slice(4,5)}/${s.slice(5,7)}`; }

/* ======= Estado ======= */
const state = { 
    data: {}, 
    base: {}, 
    augmentedBase: {}, 
    concla: new Map(), 
    filter: { 
        q:'', 
        nivel: '', 
        diretoria: ''
    }, 
    edited: null
};

/* ======= Firebase ======= */
let db;
let uid = null;
function initFirebase(){
  const firebaseConfig = window.firebaseConfig || {
    // Firebase config
  };
  firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
  firebase.auth().signInAnonymously()
    .then((cred)=>{
      uid = cred.user.uid;
      loadFirebaseUpdates();
    })
    .catch((err)=> console.error('Erro de autenticação Firebase', err));
}
async function loadFirebaseUpdates(){
  if(!uid) return;
  const snap = await db.collection('users').doc(uid).collection('updates').get();
  snap.forEach(doc=>{ state.data[doc.id] = doc.data(); });
  refresh();
}
async function saveUpdateToFirebase(code, data){
  if(!uid) return;
  await db.collection('users').doc(uid).collection('updates').doc(code).set(data);
}

/* ======= Importadores / Normalizadores ======= */
function normalizeRevisado(json){
  const out={};
  if(json && typeof json==='object' && !Array.isArray(json)){
    for(const [code, obj] of Object.entries(json)){
      const atividades = Array.isArray(obj.atividades)? obj.atividades.map(a=>({
        diretoria: a.diretoria||'',
        condicionante_risco: a.condicionante_risco||'',
        tipologia: a.tipologia||'',
        nivel_de_risco: (mapRoman[a.nivel_de_risco]||'I')
      })) : [];
      out[code] = { cnae:code, denominacao: obj.denominacao||'', atividades, obs: obj.observacao||obj.obs||'' };
    }
  } else if(Array.isArray(json)){
    for(const row of json){
      const code = String(row.CNAE||row.cnae||'').trim(); if(!code) continue;
      if(!out[code]) out[code] = { cnae: code, denominacao: row.Descrição||row.descricao||'', atividades: [], obs: row.obs||'' };
      const nivel = mapRoman[row["Nível de Risco"]||row.nivel_risco||row.nivel||'I']||'I';
      out[code].atividades.push({ diretoria: row.Diretoria||row.diretoria||'', condicionante_risco: (row.Condicionantes||row.condicionantes||'').toString(), tipologia: (row.Tipologia||row.tipologia||'').toString(), nivel_de_risco: nivel });
    }
  }
  return out;
}
function normalizeBase(json){
  const out={};
  const rows = Array.isArray(json)? json : Object.entries(json||{}).map(([k,v])=>({CNAE:k, ...v}));
  for(const row of rows){
    const code = String(row.CNAE||row.cnae||row.codigo||'').trim(); if(!code) continue;
    const baseActs = [];
    const rf = row.RiscoFixo ?? row.Risco ?? row.risco ?? row.RiscoBase ?? row["Risco Base"];
    if(rf){ baseActs.push({ diretoria: row.Diretoria||row.diretoria||'', condicionante_risco:'', tipologia: row.Tipologia||row.tipologia||'', nivel_de_risco: mapRoman[rf]||'I' }); }
    const perguntas = row.Perguntas||row.perguntas||[];
    if(Array.isArray(perguntas)){
      for(const p of perguntas){
        const opts = p.options||p.opcoes||[];
        for(const opt of opts){ if(opt && opt.risk!=null){ baseActs.push({ diretoria: row.Diretoria||row.diretoria||'', condicionante_risco: ((p.text||p.pergunta||'')+(opt.value? (': '+opt.value):'')), tipologia: row.Tipologia||row.tipologia||'', nivel_de_risco: mapRoman[opt.risk]||'I' }); } }
      }
    }
    out[code] = { cnae:code, denominacao: row.Denominacao||row.Denominação||row.descricao||row.Descrição||row.denominacao||'', atividades: baseActs, obs: row.Observacao||row.observacao||'' };
  }
  return out;
}

/* ======= IBGE / CONCLA ======= */
const IBGE = {
  base: 'https://servicodados.ibge.gov.br/api/v2/cnae',
  async fetchAll(){ const r = await fetch(`${IBGE.base}/subclasses`); if(!r.ok) throw new Error('IBGE'); const arr = await r.json(); const m=new Map(); for(const s of arr){ m.set(String(s.id), { id:String(s.id), descricao:(s.descricao||s.titulo||'').trim() }); } return m; },
};

/* ======= Regras de risco e inconsistências ======= */
function aggregateRisk(ativs){
  const raw = (ativs||[]).map(a=> mapRoman[a?.nivel_de_risco] || '').filter(r=> r==='I' || r==='II' || r==='III');
  const set = new Set(raw);
  if(set.size===0) return 'I';
  const order = ['I','II','III'];
  return order.filter(r => set.has(r)).join('/');
}
function detectIssues(entry){
  const at = entry.atividades||[]; const issues=[];
  const uniqRisk = [...new Set(at.map(a=>a.nivel_de_risco).filter(Boolean))];
  const hasCond  = at.some(a=> (a.condicionante_risco||'').trim()!=='' );
  if(hasCond && uniqRisk.length===1) issues.push('Condicionantes com risco único');
  const byRisk = new Map();
  for(const a of at){ if(!a.nivel_de_risco) continue; if(!byRisk.has(a.nivel_de_risco)) byRisk.set(a.nivel_de_risco, new Set()); byRisk.get(a.nivel_de_risco).add((a.condicionante_risco||'').trim()||'<vazio>'); }
  for(const [r,set] of byRisk){ if(set.size>1) issues.push(`Múltiplas cond. → mesmo risco ${r}`); }
  const sig = new Set();
  for(const a of at){ const key=[a.diretoria,a.condicionante_risco,a.tipologia,a.nivel_de_risco].join('|'); if(sig.has(key)){ issues.push('Atividades duplicadas'); break; } sig.add(key); }
  return issues;
}
function summarize(entry){
  const diret = [...new Set((entry.atividades||[]).map(a=>a.diretoria).filter(Boolean))];
  const tipos = [...new Set((entry.atividades||[]).map(a=>a.tipologia).filter(Boolean))];
  const conds = (entry.atividades||[]).map(a=>a.condicionante_risco).filter(Boolean);
  const risk  = aggregateRisk(entry.atividades||[]);
  const riskSet = new Set(risk.split('/'));
  const riskLabel = risk;
  const issues= detectIssues(entry);
  return {diretorias: diret, tipologias: tipos, conds, risk: riskLabel, riskSet, issues};
}

/* ======= Renderização ======= */
function rebuildFilters() {
    const diretoriaCombos = new Set();
    for (const e of Object.values(state.data)) {
        const dirs = summarize(e).diretorias;
        if (dirs.length > 0) {
            diretoriaCombos.add(dirs.sort().join(','));
        }
    }

    const sortedCombos = [...diretoriaCombos].sort((a, b) => {
        const aLen = a.split(',').length;
        const bLen = b.split(',').length;
        if (aLen !== bLen) return aLen - bLen;
        return a.localeCompare(b);
    });

    const combo = $('#filtroDiretoriaCombo');
    combo.innerHTML = '<option value="">Filtrar por Diretoria (todas)</option>';
    
    const singles = sortedCombos.filter(c => !c.includes(','));
    const multiples = sortedCombos.filter(c => c.includes(','));
    
    if (singles.length > 0) {
        let group = '<optgroup label="Individuais">';
        singles.forEach(d => {
            group += `<option value="${d}">Somente ${d}</option>`;
        });
        group += '</optgroup>';
        combo.innerHTML += group;
    }
    
    if (multiples.length > 0) {
        let group = '<optgroup label="Combinações">';
        multiples.forEach(c => {
            const label = c.split(',').join(' e ');
            group += `<option value="${c}">${label}</option>`;
        });
        group += '</optgroup>';
        combo.innerHTML += group;
    }
}


function riskPill(r){
  if (r === '—') return '<span class="muted">—</span>';
  const parts = String(r||'').split('/').filter(Boolean);
  const pill = (x)=> x==='I' ? '<span class="pill lvl-1">I</span>' : (x==='II' ? '<span class="pill lvl-2">II</span>' : (x==='III' ? '<span class="pill lvl-3">III</span>' : `<span class="pill">${escapeHtml(x)}</span>`));
  return parts.map(pill).join('');
}

function renderTable() {
    const tb = $('#tbody');
    if (!tb) return;
    tb.innerHTML = '';
    const q = (state.filter.q || '').toLowerCase();
    
    const requiredNiveis = state.filter.nivel ? new Set(state.filter.nivel.split(',')) : null;
    const requiredDiretorias = state.filter.diretoria ? new Set(state.filter.diretoria.split(',')) : null;

    const rows = [];
    for (const e of Object.values(state.data)) {
        const s = summarize(e);
        
        const nivelMatch = !requiredNiveis || areSetsEqual(s.riskSet, requiredNiveis);
        const diretoriaSet = new Set(s.diretorias);
        const diretoriaMatch = !requiredDiretorias || areSetsEqual(diretoriaSet, requiredDiretorias);

        if (!nivelMatch || !diretoriaMatch) continue;

        const hay = [e.cnae, e.denominacao].join(' ').toLowerCase();
        if (q && !hay.includes(q)) continue;

        rows.push({ e, s });
    }
    rows.sort((a, b) => a.e.cnae.localeCompare(b.e.cnae));

    const frag = document.createDocumentFragment();
    for (const { e, s } of rows) {
        const baseEntry = state.augmentedBase[e.cnae];
        const baseRisk = baseEntry ? aggregateRisk(baseEntry.atividades) : 'I';
        const currentRisk = s.risk;
        
        const tr = document.createElement('tr');
        if (baseRisk !== currentRisk) {
            tr.classList.add('risk-changed');
        }

        tr.innerHTML = `
            <td><strong>${e.cnae}</strong></td>
            <td>${e.denominacao || '<span class="muted">(sem denominação)</span>'}</td>
            <td><div class="chips">${s.diretorias.map(d => `<span class="chip">${d}</span>`).join('') || '<span class="muted">—</span>'}</div></td>
            <td>${riskPill(baseRisk)}</td>
            <td>${riskPill(currentRisk)}</td>
            <td><button class="btn" data-edit="${e.cnae}" title="Editar"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button></td>`;
        
        tr.addEventListener('click', (ev) => { if (!ev.target.closest('button')) openEdit(e.cnae); });
        tr.querySelector('[data-edit]').addEventListener('click', (ev) => { ev.stopPropagation(); openEdit(e.cnae); });
        frag.appendChild(tr);
    }
    tb.appendChild(frag);
    renderIssuesPanel();
}
function renderIssuesPanel(){
  const items=[]; for(const e of Object.values(state.data)){ const s=summarize(e); s.issues.forEach(issue=> items.push({code:e.cnae, denom:e.denominacao, issue})); }
  setHtml('#issues', items.length? ('<ul style="padding-left:18px;margin:6px 0;">'+ items.slice(0,150).map(i=> `<li><strong>${i.code}</strong> — ${escapeHtml(i.denom||'')} • ${escapeHtml(i.issue)}</li>`).join('') + '</ul>') : 'Nenhuma inconsistência localizada.');
}

/* ======= Contagem por CNAE ======= */
function minRiskLevel(ativs){
  const levels = (ativs||[]).map(a=> mapRoman[a?.nivel_de_risco] || '').filter(r=> r==='I' || r==='II' || r==='III');
  if(levels.length===0) return 'I';
  let best = 'III';
  for(const r of levels){ if(mapArab[r] < mapArab[best]) best = r; }
  return best;
}
function countByMinRisk(dataset){
  let I=0, II=0, III=0;
  const total = Object.keys(dataset).length;
  for(const e of Object.values(dataset)){
    const r = minRiskLevel(e.atividades);
    if(r==='I') I++; else if(r==='II') II++; else if(r==='III') III++;
  }
  return {I,II,III,total};
}

function renderKPIs(){
  const cur = countByMinRisk(state.data);
  setText('#statI', cur.I); setText('#statII', cur.II); setText('#statIII', cur.III); setText('#statTotal', cur.total);

  if(Object.keys(state.augmentedBase).length){
    const b = countByMinRisk(state.augmentedBase);
    setText('#statIBase', `vigente: ${b.I}`); setText('#statIIBase', `vigente: ${b.II}`); setText('#statIIIBase', `vigente: ${b.III}`); setText('#statTotalBase', `vigente: ${b.total}`);
    const f = (n)=> (n>0? `+${n}` : n);
    setHtml('#resumoBase', `<strong>Variação:</strong> I <span class="${cur.I > b.I ? 'ok' : 'danger'}">${f(cur.I - b.I)}</span> • II <span class="${cur.II > b.II ? 'warn' : 'ok'}">${f(cur.II - b.II)}</span> • III <span class="${cur.III > b.III ? 'danger' : 'ok'}">${f(cur.III - b.III)}</span>`);
  } else {
    setText('#statIBase', 'vigente: —'); setText('#statIIBase', 'vigente: —'); setText('#statIIIBase', 'vigente: —'); setText('#statTotalBase', 'vigente: —');
    setText('#resumoBase', 'Importe a base (cnae.json) para ver o comparativo.');
  }
}

function refresh(){ rebuildFilters(); renderKPIs(); renderTable(); buildRelatorio(); }

/* ======= Modal ======= */
function openEdit(code){
  const e=state.data[code]; if(!e) return;
  state.edited=code;
  setText('#dlgTitle', e.denominacao||'(sem denominação)');
  setText('#dlgCnae', code);
  const aggr=aggregateRisk(e.atividades);
  const riskEl=$('#dlgRisk');
  if(riskEl){ riskEl.className='pill '+(aggr==='I'?'lvl-1':aggr==='II'?'lvl-2':aggr==='III'?'lvl-3':'lvl-p'); riskEl.textContent=aggr; }
  const d1=$('#dlgDenom'), d2=$('#dlgObs'); if(d1) d1.value = e.denominacao||''; if(d2) d2.value=e.obs||'';
  renderActs(e);
  const dlg=$('#dlg'); if(dlg && dlg.showModal) dlg.showModal();
}
function closeEdit(){ const dlg=$('#dlg'); if(dlg) dlg.close(); state.edited=null; }
function renderActs(e){ const host=$('#acts'); if(!host) return; host.innerHTML=''; (e.atividades=e.atividades||[]).forEach((a,idx)=> host.appendChild(actRow(e,a,idx)) ); }
function actRow(entry,a,idx){
  const row=document.createElement('div'); row.className='act';
  row.innerHTML = `
  <input placeholder="Diretoria" value="${escapeHtml(a.diretoria||'')}">
  <input placeholder="Condicionante" value="${escapeHtml(a.condicionante_risco||'')}">
  <input placeholder="Tipologia" value="${escapeHtml(a.tipologia||'')}">
  <select>
    <option ${a.nivel_de_risco==='I'?'selected':''}>I</option>
    <option ${a.nivel_de_risco==='II'?'selected':''}>II</option>
    <option ${a.nivel_de_risco==='III'?'selected':''}>III</option>
  </select>
  <button class="btn" title="Remover"><svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>`;
  const [dir,cond,tip,sel,btn]=row.querySelectorAll('input,select,button');
  if(dir) dir.oninput=()=> a.diretoria=dir.value;
  if(cond) cond.oninput=()=> a.condicionante_risco=cond.value;
  if(tip) tip.oninput=()=> a.tipologia=tip.value;
  if(sel) sel.onchange=()=> a.nivel_de_risco=sel.value;
  if(btn) btn.onclick=()=>{ entry.atividades.splice(idx,1); renderActs(entry); };
  return row;
}

/* ======= Eventos / IO / IBGE ======= */
function wireEvents(){
  $('#btnTheme').onclick = ()=> {
    const cur = document.documentElement.getAttribute('data-theme') || 'dark';
    applyTheme(cur==='dark' ? 'light' : 'dark');
  };
  $('#btnAddAct').onclick=()=>{ if(!state.edited) return; const e=state.data[state.edited]; e.atividades.push({diretoria:'',condicionante_risco:'',tipologia:'',nivel_de_risco:'I'}); renderActs(e); };
  $('#btnSave').onclick=()=>{ const code=state.edited; if(!code) return; const e=state.data[code]; e.denominacao=$('#dlgDenom').value; e.obs=$('#dlgObs').value; closeEdit(); refresh(); toast('CNAE atualizado com sucesso.'); };
  $('#btnClose').onclick=closeEdit;

  const readFileAsJSON = async (file)=>{ const txt = await file.text(); try{ return JSON.parse(txt); }catch(e){ alert('Erro: Arquivo JSON inválido. Verifique o console para detalhes.'); console.error(e); return null; } };
  $('#fileRevisado').addEventListener('change', async ev=>{ const f=ev.target.files[0]; if(!f) return; const json=await readFileAsJSON(f); if(!json) return; state.data = normalizeRevisado(json); await $('#btnSyncIBGE').click(); toast('Base Revisada importada e sincronizada.'); });
  $('#fileBase').addEventListener('change', async ev=>{ const f=ev.target.files[0]; if(!f) return; const json=await readFileAsJSON(f); if(!json) return; state.base = normalizeBase(json); await $('#btnSyncIBGE').click(); toast('Base Vigente importada e sincronizada.'); });

  $('#btnExportJson').onclick=()=>{ const out={}; for(const [code,e] of Object.entries(state.data)){ out[code] = { denominacao: e.denominacao||'', atividades: (e.atividades||[]).map(a=>({ diretoria:a.diretoria||'', condicionante_risco:a.condicionante_risco||'', tipologia:a.tipologia||'', nivel_de_risco:a.nivel_de_risco||'I' })), observacao: e.obs||'' }; } const blob=new Blob([JSON.stringify(out,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='classificacao_revisada_export.json'; a.click(); };
  $('#btnExportExcel').onclick=()=>{
    const rowsResumo=[["CNAE","Denominação","Diretorias","Tipologias","Risco agregado","Qtde conds","Inconsistências"]];
    const rowsAt=[["CNAE","Denominação","Diretoria","Condicionante","Tipologia","Risco"]];
    for(const e of Object.values(state.data)){
      const s=summarize(e); rowsResumo.push([e.cnae, e.denominacao, s.diretorias.join('; '), s.tipologias.join('; '), s.risk, s.conds.length, s.issues.join(' | ')]);
      for(const a of (e.atividades||[])){ rowsAt.push([e.cnae, e.denominacao, a.diretoria, a.condicionante_risco, a.tipologia, a.nivel_de_risco]); }
    }
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rowsResumo), 'Resumo');
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rowsAt), 'Atividades');
    const rel=[]; if(Object.keys(state.augmentedBase).length){ 
        for(const [code,e] of Object.entries(state.data)){ 
            const b = state.augmentedBase[code]; 
            if(!b) continue; 
            const s = summarize(e);
            const rNow=aggregateRisk(e.atividades), rBase=aggregateRisk(b.atividades); 
            if(rNow!==rBase){ 
                const up = (mapArab[rNow]||0)>(mapArab[rBase]||0); 
                rel.push({ 
                    CNAE:code, 
                    Descrição:e.denominacao||'', 
                    Diretoria: s.diretorias.join('; '),
                    "Risco Base": rBase, 
                    "Risco Revisado": rNow, 
                    Mudança: (up? 'AUMENTOU':'DIMINUIU') 
                }); 
            } 
        } 
    }
    if(rel.length){ XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rel), 'Relatorio'); }
    XLSX.writeFile(wb, 'cnae_risco_exportado.xlsx');
  };

  $('#btnSyncIBGE').onclick = async () => {
      if (!Object.keys(state.data).length && !Object.keys(state.base).length) {
        return alert('Importe ou carregue ao menos uma base (Vigente ou Revisada) antes de sincronizar.');
      }
      toast('Sincronizando com IBGE/CONCLA...');
      try {
        const all = await IBGE.fetchAll();
        state.concla = all;
        let addData = 0;
        let augBase = {};

        for (const [id, obj] of all) {
          const code = subclassDigitsToCNAE(id);
          
          if (!state.data[code]) {
            state.data[code] = { cnae: code, denominacao: obj.descricao, atividades: [{ diretoria: '', condicionante_risco: '', tipologia: '', nivel_de_risco: 'I' }], obs: '' };
            addData++;
          } else if (obj.descricao && state.data[code].denominacao !== obj.descricao) {
             state.data[code].denominacao = obj.descricao;
          }

          if (state.base[code]) {
             augBase[code] = JSON.parse(JSON.stringify(state.base[code]));
             if (obj.descricao && augBase[code].denominacao !== obj.descricao) {
                 augBase[code].denominacao = obj.descricao;
             }
          } else {
            augBase[code] = { cnae: code, denominacao: obj.descricao, atividades: [{ diretoria: '', condicionante_risco: '', tipologia: '', nivel_de_risco: 'I' }], obs: '' };
          }
        }
        
        state.augmentedBase = augBase;
        
        refresh();
        toast(`Sincronizado: ${addData > 0 ? `${addData} CNAEs novos adicionados/atualizados.` : 'Denominações atualizadas.'}`);
      } catch (e) {
        alert('Erro ao conectar com a API do IBGE: ' + e.message);
      }
    };
  
  $('#q').oninput = (e)=>{ state.filter.q = e.target.value; renderTable(); };
  $('#filtroNivelCombo').onchange = (e) => { state.filter.nivel = e.target.value; renderTable(); };
  $('#filtroDiretoriaCombo').onchange = (e) => { state.filter.diretoria = e.target.value; renderTable(); };
}

/* ======= Relatório texto ======= */
function buildRelatorio(){
  if(!Object.keys(state.augmentedBase).length || !Object.keys(state.data).length){ setText('#relatorio','Importe a Base (cnae.json) e o Revisado para ver mudanças.'); return; }
  const linhas=[]; 
  for(const [code,e] of Object.entries(state.data)){
    const b = state.augmentedBase[code];
    if(!b) continue;
    const rNow=aggregateRisk(e.atividades), rBase=aggregateRisk(b.atividades);
    if(rNow!==rBase){
      const toMax = (label)=> Math.max(...(String(label).split('/').map(x=> mapArab[x]||0)));
      const up = toMax(rNow) > toMax(rBase);
      const arrow = up ? '↑ AUMENTOU' : '↓ DIMINUIU';
      linhas.push(`${code} • Base: ${rBase} → Atual: ${rNow} <strong class="${up ? 'danger' : 'ok'}">(${arrow})</strong>`);
    }
  }
  setHtml('#relatorio', linhas.length? ('<ul style="padding-left:18px;margin:6px 0; list-style-type: none;">'+linhas.map(x=>`<li>${x}</li>`).join('')+'</ul>') : '<span class="ok">Nenhuma alteração de nível de risco em relação à base.</span>');
}

/* ======= Boot ======= */
async function autoInit(){
  if(typeof normalizeBase !== 'function'){ return setTimeout(autoInit, 50); }
  
  const basePromise = tryFetchJSON('cnae.json');
  const revisadoPromise = tryFetchJSON('revisaorisco_atualizado_corrigido.json');

  const [base, revisado] = await Promise.all([basePromise, revisadoPromise]);
  let baseLoaded = false;
  let revisadoLoaded = false;

  if(base) {
    state.base = normalizeBase(base);
    toast('Base Vigente (cnae.json) carregada.');
    baseLoaded = true;
  } else {
    toast('Aviso: arquivo "cnae.json" não encontrado ou com erro.');
  }

  if(revisado) {
    state.data = normalizeRevisado(revisado);
    toast('Base Revisada (revisaorisco_atualizado_corrigido.json) carregada.');
    revisadoLoaded = true;
  } else {
    toast('Aviso: "revisaorisco_atualizado_corrigido.json" não encontrado ou com erro.');
  }
  
  if (!revisadoLoaded && baseLoaded) {
    state.data = JSON.parse(JSON.stringify(state.base));
    toast('Base Vigente copiada para a área de trabalho.');
  }

  if (Object.keys(state.data).length > 0 || Object.keys(state.base).length > 0) {
    const syncButton = $('#btnSyncIBGE');
    if (syncButton) {
        setTimeout(() => syncButton.click(), 500);
    }
  } else {
    refresh();
  }
}

function init(){
  initTheme();
  wireEvents();
  initFirebase();
  autoInit();
}

if(document.readyState === 'loading'){ 
  document.addEventListener('DOMContentLoaded', init); 
} else { 
  init(); 
}
</script>

</body>
</html>